resources:
  repositories:
    - repository: common-templates
      type: github
      name: wso2-enterprise/choreo-common-pipeline-templates
      endpoint: wso2-enterprise
      
trigger: none

pr:
  branches:
    include:
      - 'main'

variables:
  - group: choreo-samples

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: "3.x"
      addToPath: true

  - script: |
      python -m pip install --upgrade pip
      pip install pyyaml
    displayName: "Install dependencies"

  - script: |
      python .azure/scripts/validate_samples.py
    displayName: "Metadata Validation"

  - script: |
      echo "##[group]Set IMAGE_URLS variable"
      echo "Reading image URLs from image_urls.txt"

      # Install jq if not already installed
      if ! command -v jq &> /dev/null; then
        echo "jq not found, installing..."
        sudo apt-get update && sudo apt-get install -y jq
      fi

      # Read image_urls.txt and convert to JSON array
      IMAGE_URLS=$(jq -R -s -c 'split("\n") | map(select(length > 0))' image_urls.txt)
      echo "IMAGE_URLS content:"
      echo "$IMAGE_URLS"

      # Set the IMAGE_URLS variable
      echo "##vso[task.setvariable variable=IMAGE_URLS]$IMAGE_URLS"
      echo "##[endgroup]"
    displayName: "Read image_urls.txt"

  - template: install/install-trivy.yaml@common-templates
  - template: pr/trivy-scan.yaml@common-templates
    parameters:
      IMAGES: ${{ fromJson(variables.IMAGE_URLS) }}


  - script: echo 'Pull Request Validation Completed'
    displayName: "PR Validation Completed"
